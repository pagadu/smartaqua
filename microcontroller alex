#include "SensorActuator.h"
#include "MeshServices.h"
#include "MeshRadio.h"
#include "Router.h"
#include "NodeDB.h"

// ==================== External core objects ====================
extern MeshService *service;
extern Router *router;
extern NodeDB *nodeDB;
extern const RegionInfo *myRegion;
extern Channels channels;

// ==================== Pin assignments (GPIO numbers) ====================
#define DHTPIN   6
#define LUXPIN   7
#define TRIGPIN  5
#define ECHOPIN  4
#define LED_TEMP 7

// ======== tiny helpers ========
static bool radioReady()
{
    if (!router || !nodeDB) return false;

    meshtastic_QueueStatus qs = router->getQueueStatus();
    if (nodeDB->getNodeNum() == 0) return false;
    if (qs.maxlen == 0) return false;

    return true;
}

SensorActuatorModule::SensorActuatorModule()
    : dht(DHTPIN), lastSend(0) {}

void SensorActuatorModule::setup() {
    Serial.begin(115200);
    delay(2000);
    Serial.println("[SensorActuator] setup()");

#if defined(SENSOR_NODE)
    dht.begin();
    pinMode(TRIGPIN, OUTPUT);
    pinMode(ECHOPIN, INPUT);
    Serial.println("[SensorActuator] SENSOR_NODE ready.");

#elif defined(ACTUATOR_NODE)
    pinMode(LED_TEMP, OUTPUT);
    Serial.println("[SensorActuator] ACTUATOR_NODE ready.");
#endif
}

void SensorActuatorModule::loop() {
    static bool pskReady = false;
    if (!pskReady && radioReady()) {
        (void)channels.setActiveByIndex(0);
        Serial.println("[SensorActuator] ðŸ”‘ PSK context primed (channel 0).");
        pskReady = true;
    }

#if defined(SENSOR_NODE)
    if (pskReady && (millis() - lastSend >= SEND_INTERVAL)) {
        lastSend = millis();
        sendSensorData();
    }
#endif
}

// ====================================================
// SENSOR NODE â€“ Send sensor readings (JSON version)
// ====================================================
void SensorActuatorModule::sendSensorData() {
    if (!radioReady()) {
        Serial.println("[SensorActuator] â³ Radio not ready yet; skip.");
        return;
    }

    float h = 0, t = 0;
    int lux = analogRead(LUXPIN);

    if (!dht.read(h, t)) {
        Serial.println("[SensorActuator] âš ï¸ DHT read failed!");
    }

    digitalWrite(TRIGPIN, LOW);
    delayMicroseconds(2);
    digitalWrite(TRIGPIN, HIGH);
    delayMicroseconds(10);
    digitalWrite(TRIGPIN, LOW);

    long duration = pulseIn(ECHOPIN, HIGH, 30000);
    float distance = (duration == 0) ? NAN : duration * 0.034f / 2.0f;

    // ============ JSON PAYLOAD ============
    String payload = "{";
    payload += "\"temp\":" + String(t,1) + ",";
    payload += "\"hum\":"  + String(h,1) + ",";
    payload += "\"lux\":"  + String(lux) + ",";
    payload += "\"dist\":" + String(distance,1);
    payload += "}";

    Serial.println("[SensorActuator] Sending JSON â†’ " + payload);

    meshtastic_MeshPacket *p = router->allocForSending();
    if (!p) {
        Serial.println("[SensorActuator] âŒ Packet alloc failed");
        return;
    }

    strlcpy((char *)p->decoded.payload.bytes, payload.c_str(),
            sizeof(p->decoded.payload.bytes));

    p->decoded.payload.size = strlen((char *)p->decoded.payload.bytes);
    p->decoded.portnum = meshtastic_PortNum_TEXT_MESSAGE_APP;

    p->to = 0xFFFFFFFF;
    p->channel = 0;
    p->pki_encrypted = false;
    p->want_ack = false;

    if (p->hop_limit == 0) p->hop_limit = 3;

    ErrorCode result = router->sendLocal(p, RX_SRC_LOCAL);

    if (result == ERRNO_OK)
        Serial.println("[SensorActuator] âœ… Sent JSON successfully!");
    else
        Serial.printf("[SensorActuator] âš ï¸ sendLocal failed (%d)\n", result);
}

// ====================================================
// ACTUATOR NODE â€“ Read JSON + blink LED
// ====================================================
void SensorActuatorModule::handleIncomingPacket(meshtastic_MeshPacket *p) {
    if (!MeshService::isTextPayload(p)) return;

    String msg = String((char *)p->decoded.payload.bytes);
    Serial.println("[SensorActuator] Received: " + msg);

#if defined(ACTUATOR_NODE)
    // ============ JSON DETECTION ============
    if (msg.startsWith("{") && msg.endsWith("}")) {
        Serial.println("[SensorActuator] âœ… JSON detected â€” LED blink");
        digitalWrite(LED_TEMP, HIGH);
        delay(400);
        digitalWrite(LED_TEMP, LOW);
    } else {
        Serial.println("[SensorActuator] Ignored non-JSON message");
    }
#endif

    if (myRegion) {
        Serial.printf("[SensorActuator] Region: %s (%.2fâ€“%.2f MHz)\n",
                      myRegion->name, myRegion->freqStart, myRegion->freqEnd);
    }
}
